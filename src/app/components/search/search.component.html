<ng-container *ngIf="!(loading$ | async)">
    <div class="search-page" cdkScrollable>

        <!-- Header -->
        <div class="training-plan-header" (click)="goToTrainingPlan()">
            <h1 class="plan-name">
                {{ currentPlan.name }}
                <mat-icon class="arrow-icon">arrow_forward</mat-icon>
            </h1>
        </div>


        <!-- Search input -->
        <div class="search-bar">
            <mat-icon>search</mat-icon>
            <input type="text" placeholder="Rechercher par nom ou description" [(ngModel)]="query" (input)="onSearch()" />
        </div>

        <!-- Filters 
        <div class="filters">
            <button class="chip" [class.active]="activeFilter === 'all'" (click)="setFilter('all')">Tous</button>

            <button class="chip" (click)="setFilter('distance')">Distance</button>
            <button class="chip" (click)="setFilter('elevation')">Dénivelé</button>
            <button class="chip" (click)="setFilter('difficulty')">Difficulté</button>
        </div> -->

        <div class="content-layout">
            <!-- Filters column -->
            <aside class="filters-panel">
                
                    <div class="filters-header">
                        <h4 class="filters-title">Filtres</h4>
                        <button class="filters-btn" (click)="resetFilters()">Réinitialiser les filtres</button>
                    </div>
                    <mat-divider></mat-divider>

                    <div class="filters-scroll">
                    <!-- Type d'activité -->
                    <div class="filter-section">
                        <h5 class="filter-title-with-badge" matBadge="{{ selectedActivityTypesCount }}" matBadgeHidden="{{ selectedActivityTypesCount === 0 }}" matBadgeSize="small">
                            Type d'activité
                        </h5>

                        <div class="checkbox-row">
                            <mat-checkbox *ngFor="let type of activityTypes" [(ngModel)]="type.checked" (change)="applyFilters()">
                                {{ type.label }}
                            </mat-checkbox>
                        </div>
                    </div>
                    <mat-divider></mat-divider>
                    <!-- Tag -->
                    <div class="filter-section">
                        <h5 class="filter-title-with-badge" matBadge="{{ selectedTagsCount  }}" matBadgeHidden="{{ selectedTagsCount  === 0 }}" matBadgeSize="small">
                            Tag
                        </h5>
                        <div class="tag-list" [class.collapsed]="!showAllTags">
                            <button class="tag" *ngFor="let code of allTags" [class.active]="isTagSelected(code)" (click)="toggleTag(code)">
                                {{ ('i18n.session_type.label.' + code) | translate }}
                            </button>
                        </div>

                        <button class="filters-btn center-btn" (click)="showAllTags = !showAllTags">
                            {{ showAllTags ? 'Afficher moins' : 'Afficher tout' }}
                        </button>
                    </div>
                    <mat-divider></mat-divider>
                    <div class="filter-section">
                        <h5 class="filter-title-with-badge" matBadge="{{ distanceFilterBadge }}" matBadgeHidden="{{ !isDistanceFilterActive }}" matBadgeSize="small">
                            Distance (km)
                        </h5>
                        <div class="range-values">
                            <span>{{ formatDistance(minDistance) }}</span>
                            <span>{{ formatDistance(maxDistance) }}</span>
                        </div>
                        <mat-slider min="0" max="MAX_DISTANCE" step="1" thumbLabel (change)="applyFilters()">
                            <input matSliderStartThumb [(ngModel)]="minDistance">
                            <input matSliderEndThumb [(ngModel)]="maxDistance">
                        </mat-slider>
                    </div>
                    <mat-divider></mat-divider>
                    <div class="filter-section">
                        <h5 class="filter-title-with-badge" matBadge="{{ elevationFilterBadge }}" matBadgeHidden="{{ !isElevationFilterActive }}" matBadgeSize="small">
                            Dénivelé (m)
                        </h5>
                        <div class="range-values">
                            <span>{{ formatElevation(minElevation) }}</span>
                            <span>{{ formatElevation(maxElevation) }}</span>
                        </div>
                        <mat-slider min="0" [max]="MAX_ELEVATION" step="10" thumbLabel (change)="applyFilters()">
                            <input matSliderStartThumb [(ngModel)]="minElevation">
                            <input matSliderEndThumb [(ngModel)]="maxElevation">
                        </mat-slider>
                    </div>
                    <mat-divider></mat-divider>
                    <!-- Temps -->
                    <div class="filter-section">
                        <h5 class="filter-title-with-badge" matBadge="{{ durationFilterBadge }}" matBadgeHidden="{{ !isDurationFilterActive }}" matBadgeSize="small">
                            Temps d'activité
                        </h5>
                        <div class="range-values">
                            <span>{{ formatDuration(minDuration) }}</span>
                            <span>{{ formatDuration(maxDuration) }}</span>
                        </div>
                        <mat-slider min="0" [max]="MAX_DURATION" step="5" thumbLabel (change)="applyFilters()">
                            <input matSliderStartThumb [(ngModel)]="minDuration">
                            <input matSliderEndThumb [(ngModel)]="maxDuration">
                        </mat-slider>
                    </div>
                    <mat-divider></mat-divider>
                    <!-- Date -->
                    <div class="filter-section">
                        <h5 class="filter-title-with-badge" matBadge="{{ durationFilterBadge }}" matBadgeHidden="{{ !isDateFilterActive }}" matBadgeSize="small">
                            Date
                        </h5>
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-date-range-input [rangePicker]="picker" [min]="minDate" [max]="maxDate">
                                <input matStartDate placeholder="Du" [(ngModel)]="selectedStartDate" (dateChange)="onDateRangeChange()">
                                <input matEndDate placeholder="Au" [(ngModel)]="selectedEndDate" (dateChange)="onDateRangeChange()">
                            </mat-date-range-input>

                            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                            <mat-date-range-picker #picker></mat-date-range-picker>
                        </mat-form-field>
                    </div>
                    <mat-divider></mat-divider>
                    <!-- Lieu -->
                    <div class="filter-section">
                        <h5 class="filter-title-with-badge" matBadge="{{ selectedLocationCount }}" matBadgeHidden="{{ !isLocationFilterActive }}" matBadgeSize="small">
                            Lieu
                        </h5>
                        <!-- Pays -->
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Pays</mat-label>
                            <mat-select multiple [(ngModel)]="selectedCountries" (selectionChange)="applyFilters()" disableOptionCentering>
                                <mat-option *ngFor="let country of allCountries" [value]="country">
                                    <div class="country-option">
                                        <img [src]="'assets/images/flag/' + country + '.png'" />    
                                        {{ Country[country] }}
                                    </div>
                                </mat-option>
                            </mat-select>
                        </mat-form-field>

                        <!-- Ville -->
                        <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Ville</mat-label>
                            <mat-select multiple [(ngModel)]="selectedCities" (selectionChange)="applyFilters()">
                                <mat-option *ngFor="let city of filteredCities" [value]="city">
                                    {{ city }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
            </aside>

            <!-- Results column -->
            <section class="results-panel">
                <div class="results" *ngIf="filteredActivities.length > 0; else nodata">

                    <span class="total-activities">{{ filteredActivities.length }} activités trouvées.</span>

                    <div class="result-card" *ngFor="let activity of filteredActivities">

                        <div class="map-preview">
                            <app-polyline-preview [polyline]="activity.polyline"></app-polyline-preview>
                        </div>

                        <div class="info">
                            <h3>{{ activity.name }}</h3>

                            <div class="meta">
                                <img [src]="activity.sportType === 'TrailRun' ? 'assets/images/trail-icon-24px.svg' : 'assets/images/run-icon-24px.svg'" />
                                <span>{{ activity.distance }} km</span>
                                <span>•</span>
                                <span>{{ activity.totalElevationGain }} m</span>
                                <span>•</span>
                                <span>{{ globalService.formatTime(activity.movingTime) }}</span>
                            </div>

                            <div class="session-tag" *ngIf="activity.sessionType">
                                <mat-icon class="tag-icon">local_offer</mat-icon>
                                <span class="tag-label">
                                    {{ 'i18n.session_type.label.' + activity.sessionType | translate }}
                                </span>
                            </div>

                            <div class="footer">
                                <div class="location-and-date">
                                    <div *ngIf="activity.city" class="location">
                                        <img *ngIf="activity.country" class="flag" [src]="'assets/images/flag/' + activity.country + '.png'" />
                                        <span>{{ activity.city }}</span>
                                    </div>
                                    <div class="created">
                                        {{ activity.startDateLocal | date:'longDate' }}
                                    </div>
                                </div>
                                <button mat-raised-button class="button-actions" (click)="openStrava(activity.activityId)">
                                    <img src="assets/images/strava.svg" class="strava-logo" /> 
                                    <span>Ouvrir dans Strava</span>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>
                <ng-template class="nodata-container" #nodata>
                    <div class="nodata">
                        <span>Aucune activité disponible</span>
                        <span>Aucune activité ne correspond à tes critères actuels. Vérifie tes filtres ou importe une nouvelle séance.</span>
                    </div> 
                </ng-template>
            </section>


        </div>

    </div>
</ng-container>