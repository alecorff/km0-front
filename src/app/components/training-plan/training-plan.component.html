<ng-container *ngIf="currentPlan && !(loading$ | async)">
    <!-- RECAPITULATIF -->
    <div class="current-prepa-card">
        <!-- Infos principales -->
        <div class="prepa-header-line">
            <div class="prepa-info-bubble">

                <div class="info-item">
                    <mat-icon>flag</mat-icon>
                    <span>{{ currentPlan.name }}</span>
                </div>

                <div class="separator"></div>

                <div class="info-item">
                    <mat-icon>event</mat-icon>
                    <span>{{ currentPlan.endDate | date:'longDate' }}</span>
                </div>

                <div class="separator"></div>

                <div class="info-item">
                    <mat-icon>straighten</mat-icon>
                    <span>{{ currentPlan.distanceKm }} km</span>
                </div>

                <div class="separator" *ngIf="currentPlan.elevation"></div>
                <div class="info-item" *ngIf="currentPlan.elevation">
                    <mat-icon>terrain</mat-icon>
                    <span>{{ currentPlan.elevationGain }} m D+</span>
                </div>

                <div class="separator" *ngIf="currentPlan.goal"></div>
                <div class="info-item" *ngIf="currentPlan.goal">
                    <mat-icon>radar</mat-icon>
                    <span>{{ currentPlan.goal }}</span>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="prepa-stats-row">
            <div class="stat-item">
                <div class="stat-value">{{ activities.length }}</div>
                <div class="stat-label">Séances complétées</div>
            </div>

            <div class="stat-item">
                <div class="stat-value">{{ totalDistance }} km</div>
                <div class="stat-label">Distance parcourue</div>
            </div>

            <div class="stat-item" *ngIf="currentPlan.type === 'TRAIL'">
                <div class="stat-value">{{ totalElevation }} m D+</div>
                <div class="stat-label">Dénivelé total</div>
            </div>

            <div class="stat-item">
                <div class="stat-value">{{ totalTime }}</div>
                <div class="stat-label">Temps d'activité</div>
            </div>
        </div>
    </div>

    <div class="section-actions">
        <button mat-raised-button class="button-actions">
            <mat-icon>search</mat-icon>
            Recherche
        </button>
        <button mat-raised-button class="button-actions">
            <mat-icon>bar_chart</mat-icon>
            Statistiques
        </button>
    </div>

    <!-- CALENDRIER -->
    <div class="calendar-container">
        <h2 class="section-title">Plan d'entraînement</h2>

        <!-- ===== SEMAINE SÉLECTIONNÉE ===== -->
        <div *ngIf="selectedWeek.length" class="week-header">
            <button class="plan-session-link" (click)="planSession()">
                <mat-icon>more_time</mat-icon>
                <span>Planifier une séance</span>
            </button>
        </div>

        <div *ngIf="selectedWeek.length" class="week-cards">
            <div class="week-grid">
                <div class="week-day-card" [class.today-card]="d.isToday" *ngFor="let d of selectedWeek"
                    (click)="openDay(d)">
                    <div class="wd-header">
                        <div class="wd-name">{{ d.date | date:'EEEE' }}</div>
                        <div class="wd-number">{{ d.date | date:'d MMM' }}</div>
                    </div>

                    <div class="wd-content" *ngIf="d.activity || d.plannedActivity; else noActivity">
                        <!-- Activité réelle -->
                        <ng-container *ngIf="d.activity; else plannedActivityBlock">
                        <ng-container *ngIf="d.activity.length > 1; else singleActivity">
                            <span matBadge="{{ d.activity.length }}" matBadgeOverlap="false" class="activity-badge week">
                            <img [src]="d.activity[0].sportType === 'TrailRun' ? 'assets/images/trail-icon-48px.svg' : 'assets/images/run-icon-48px.svg'" />
                            </span>
                        </ng-container>
                        <ng-template #singleActivity>
                            <img [src]="d.activity.sportType === 'TrailRun' ? 'assets/images/trail-icon-48px.svg' : 'assets/images/run-icon-48px.svg'" />
                        </ng-template>
                        </ng-container>

                        <!-- Activité planifiée -->
                        <ng-template #plannedActivityBlock>
                        <ng-container *ngIf="d.plannedActivity.length > 1; else singlePlanned">
                            <span matBadge="{{ d.plannedActivity.length }}" matBadgeOverlap="false" class="planned-badge week">
                                <img src="assets/images/event-note-48px.svg" />
                            </span>
                        </ng-container>
                        <ng-template #singlePlanned>
                            <img src="assets/images/event-note-48px.svg" />
                        </ng-template>
                        </ng-template>
                    </div>

                    <!-- Pas d'activité -->
                    <ng-template #noActivity>
                        <div class="empty-msg">Aucune séance</div>
                    </ng-template>
                </div>
            </div>
        </div>

        <!-- ===== MOIS COURANT ===== -->
        <div class="month-card">
            <div class="month-header">
                <button class="nav-btn" (click)="previousMonth()" [class.hidden]="!canGoToPreviousMonth()">
                    <mat-icon>chevron_left</mat-icon>
                </button>

                <div class="month-title">
                    {{ selectedMonth | date:'MMMM y' }}
                </div>

                <button class="nav-btn" (click)="nextMonth()" [class.hidden]="!canGoToNextMonth()">
                    <mat-icon>chevron_right</mat-icon>
                </button>
            </div>

            <!-- JOURS DE LA SEMAINE -->
            <div class="weekdays">
                <div *ngFor="let wd of weekDays">{{ wd }}</div>
            </div>

            <!-- GRID DU MOIS -->
            <div class="month-grid">
                <div *ngFor="let day of monthDays" class="day-cell"
                    [class.disabled]="!day.inMonth || isOutsidePlan(day.date)" [class.today]="day.isToday"
                    [class.selected]="isSelectedDate(day.date)" (click)="selectDate(day.date)">
                    <ng-container [ngSwitch]="day.icon">
                        <!-- Course -->
                        <span *ngSwitchCase="'RUN'" [matBadge]="day.multi ? day.multi : null" matBadgeOverlap="false" class="activity-badge month">
                            <img src="assets/images/run-icon-32px.svg" />
                        </span>

                        <!-- Trail -->
                        <span *ngSwitchCase="'TRAIL'" [matBadge]="day.multi ? day.multi : null" matBadgeOverlap="false" class="activity-badge month">
                            <img src="assets/images/trail-icon-32px.svg" />
                        </span>

                        <!-- Planifiée -->
                        <span *ngSwitchCase="'PLANNED'" [matBadge]="day.multiPlanned ? day.multiPlanned : null" matBadgeOverlap="false" class="planned-badge month">
                            <img src="assets/images/event-note-32px.svg" />
                        </span>

                        <!-- Jour de course -->
                        <mat-icon *ngSwitchCase="'RACE'">
                            sports_score
                        </mat-icon>

                        <!-- Jour de départ -->
                        <mat-icon *ngSwitchCase="'START'">
                            rocket_launch
                        </mat-icon>

                        <!-- Fallback -->
                        <span *ngSwitchDefault>
                            {{ day.date.getDate() }}
                        </span>
                    </ng-container>
                </div>
            </div>
        </div>
    </div>
</ng-container>