<h2 mat-dialog-title class="title">{{ 'i18n.page.plan.create_planned_activity_dialog.title' | translate }}</h2>
<mat-divider></mat-divider>

<form [formGroup]="form" mat-dialog-content class="form-content">
  <!-- Titre -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>{{ 'i18n.page.plan.create_planned_activity_dialog.fields.name' | translate }}</mat-label>
    <input matInput formControlName="name">
    <mat-error *ngIf="form.get('name')?.hasError('required')">
      {{ 'i18n.page.plan.create_planned_activity_dialog.errorMessage.field' | translate }}
    </mat-error>
  </mat-form-field>

  <!-- Date -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>{{ 'i18n.page.plan.create_planned_activity_dialog.fields.date' | translate }}</mat-label>
    <input matInput [matDatepicker]="picker" formControlName="date" [min]="today" />
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
    <mat-error *ngIf="form.get('date')?.hasError('required')">
      {{ 'i18n.page.plan.create_planned_activity_dialog.errorMessage.date' | translate }}
    </mat-error>
  </mat-form-field>

  <!-- Session type -->
  <mat-form-field appearance="outline" class="full-width">
    <mat-label>{{ 'i18n.page.plan.create_planned_activity_dialog.fields.type' | translate }}</mat-label>

    <mat-select formControlName="sessionType">
      <ng-container *ngFor="let category of categories">
        <mat-optgroup
          [label]="'i18n.page.plan.create_planned_activity_dialog.session_category.' + category | translate">
          <mat-option *ngFor="let session of filteredSessionTypes[category]" [value]="session.code">
            {{ session.label }}
          </mat-option>
        </mat-optgroup>
      </ng-container>
    </mat-select>

    <mat-error *ngIf="form.get('sessionType')?.hasError('required')">
      {{ 'i18n.page.home.create_dialog.errorMessage.field' | translate }}
    </mat-error>
  </mat-form-field>

  <!-- Case à cocher -->
  <mat-checkbox class="custom-checkbox" formControlName="defineContent">
    Définir le contenu de la séance (optionnel)
  </mat-checkbox>

  <!-- Champs optionnels -->
  <div class="planned-content" *ngIf="form.get('defineContent')?.value">
    <span class="step-title">Etapes</span>

    <div class="training-steps" cdkDropList (cdkDropListDropped)="drop($any($event))">
      <div *ngFor="let ctrl of steps.controls; let i = index" cdkDrag class="training-block">

        <!-- ================= ÉTAPE SIMPLE ================= -->
        <ng-container *ngIf="ctrl.value.kind === 'step'" [formGroup]="asFormGroup(ctrl)">

          <div class="training-step">
            <!-- Contenu -->
            <div class="step-content">

              <!-- Ligne infos -->
              <div class="step-info">
                <button mat-button class="step-type" [matMenuTriggerFor]="typeMenu">
                  {{ ctrl.value.type === 'distance' ? 'Distance' : 'Temps' }} :
                  <span class="step-value">
                    <ng-container *ngIf="ctrl.value.type === 'distance'; else timeTpl">
                      {{ ctrl.value.distance | number:'1.2-2' || '—' }} km
                    </ng-container>
                    <ng-template #timeTpl>
                      {{ ctrl.value.time | duration }}
                    </ng-template>
                  </span>
                  <mat-icon>arrow_drop_down</mat-icon>
                </button>

                <mat-menu #typeMenu="matMenu">
                  <button mat-menu-item (click)="pickNumericValue(ctrl,'distance')">Distance</button>
                  <button mat-menu-item (click)="pickNumericValue(ctrl,'time')">Temps</button>
                </mat-menu>

                <button mat-button (click)="pickNumericValue(ctrl,'pace')">
                  Allure : {{ ctrl.value.pace | pace }} min/km
                </button>
              </div>
            </div>

            <div class="icon-actions">
              <mat-icon class="drag-icon" cdkDragHandle>reorder</mat-icon>
              <mat-icon class="remove" (click)="removeStep(i)">delete</mat-icon>
            </div>
          </div>

        </ng-container>

        <!-- ================= RÉPÉTITION ================= -->
        <ng-container *ngIf="ctrl.value.kind === 'repeat'" [formGroup]="asFormGroup(ctrl)">
          <div class="repetition-header" [formGroup]="asFormGroup(ctrl)">
            <button mat-button class="repetition-count" [matMenuTriggerFor]="countMenu">
              {{ ctrl.value.repetitionCount }}
              <mat-icon>arrow_drop_down</mat-icon>
            </button>

            <span class="times-label">fois</span>
            <mat-menu #countMenu="matMenu">
              <button mat-menu-item *ngFor="let count of repetitionCounts" (click)="ctrl.get('repetitionCount')?.setValue(count)">
                {{ count }}
              </button>
            </mat-menu>

            <mat-icon class="drag-icon" cdkDragHandle>reorder</mat-icon>
            <mat-icon class="remove" (click)="removeStep(i)">delete</mat-icon>
          </div>

          <div class="repetition-steps" formArrayName="steps">
            <div *ngFor="let sub of getRepetitionStepGroups(ctrl); let j = index" [formGroup]="sub" class="training-step sub-step">

              <div class="step-content">
                <div class="step-info">
                  <button mat-button class="step-type" [matMenuTriggerFor]="typeMenu">
                    {{ sub.value.type === 'distance' ? 'Distance' : 'Temps' }} :
                    <span class="step-value">
                      <ng-container *ngIf="sub.value.type === 'distance'; else timeTpl">
                        {{ sub.value.distance | number:'1.2-2' || '—' }} km
                      </ng-container>
                      <ng-template #timeTpl>
                        {{ sub.value.time | duration }}
                      </ng-template>
                    </span>
                    <mat-icon>arrow_drop_down</mat-icon>
                  </button>

                  <mat-menu #typeMenu="matMenu">
                    <button mat-menu-item (click)="pickNumericValue(sub,'distance')">Distance</button>
                    <button mat-menu-item (click)="pickNumericValue(sub,'time')">Temps</button>
                  </mat-menu>

                  <button mat-button (click)="pickNumericValue(sub,'pace')">
                    Allure : {{ sub.value.pace | pace }} min/km
                  </button>
                </div>
              </div>

              <div class="icon-actions">
                <mat-icon class="drag-icon" cdkDragHandle>reorder</mat-icon>
                <mat-icon class="remove" (click)="removeRepetitionStep(ctrl, j)">delete</mat-icon>
              </div>

            </div>
          </div>

        </ng-container>

      </div>
    </div>

    <!-- ACTIONS -->
    <div class="step-actions">
      <button mat-stroked-button class="action-button" (click)="addStep()">
        <mat-icon>add</mat-icon>
        Ajouter une étape
      </button>

      <button mat-stroked-button class="action-button" (click)="addRepetition()">
        <mat-icon>repeat</mat-icon>
        Ajouter une répétition
      </button>
    </div>

  </div>

</form>

<mat-dialog-actions class="submit-action">
  <button mat-raised-button class="button-actions" [disabled]="form.invalid" (click)="submit()">
    {{ 'i18n.page.plan.create_planned_activity_dialog.actions.submit' | translate }}
  </button>
</mat-dialog-actions>